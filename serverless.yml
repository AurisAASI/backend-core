org: acsfti

service: backend-core

frameworkVersion: '4'

provider:
  name: aws
  runtime: python3.10
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 128
  timeout: 30
  deploymentBucket:
    maxPreviousDeploymentArtifacts: 5
  environment:
    # Global environment variables
    ACCOUNT_ID: ${env:AWS_ACCOUNT_ID, '819774487459'}
    STAGE: ${self:provider.stage}
    REGION: ${self:provider.region}
    
    # API Key from AWS Cognito stored in environment
    API_KEY: ${env:API_KEY, ''}

    #Authentication configuration
    COGNITO_USER_POOL_ID_DEV: ${env:COGNITO_USER_POOL_ID_DEV, 'placeholder-dev'}
    COGNITO_USER_POOL_ID_PROD: ${env:COGNITO_USER_POOL_ID_PROD, 'placeholder-prod'}
    COGNITO_APP_CLIENT_ID_DEV: ${env:COGNITO_APP_CLIENT_ID_DEV, 'placeholder-dev'}
    COGNITO_APP_CLIENT_ID_PROD: ${env:COGNITO_APP_CLIENT_ID_PROD, 'placeholder-prod'}
    AUTH_CODE_VALIDITY_MINUTES: ${env:AUTH_CODE_VALIDITY_MINUTES, '5'}
    AUTH_CODE_MAX_ATTEMPTS: ${env:AUTH_CODE_MAX_ATTEMPTS, '3'}
    AUTH_CODE_LENGTH: ${env:AUTH_CODE_LENGTH, '6'}
    SES_FROM_EMAIL_DEV: ${env:SES_FROM_EMAIL_DEV, ''}
    SES_FROM_EMAIL_PROD: ${env:SES_FROM_EMAIL_PROD, ''}

    # Google Places API configuration (stage-specific)
    GOOGLE_PLACES_API_KEY_DEV: ${env:GOOGLE_PLACES_API_KEY_DEV, ''}
    GOOGLE_PLACES_API_KEY_PROD: ${env:GOOGLE_PLACES_API_KEY_PROD, ''}
    GOOGLE_PLACES_DAILY_QUOTA_LIMIT_DEV: ${env:GOOGLE_PLACES_DAILY_QUOTA_LIMIT_DEV, '10000'}
    GOOGLE_PLACES_DAILY_QUOTA_LIMIT_PROD: ${env:GOOGLE_PLACES_DAILY_QUOTA_LIMIT_PROD, '20000'}
    # Google Gemini API configuration (stage-specific)
    GEMINI_API_KEY_DEV: ${env:GEMINI_API_KEY_DEV, ''}
    GEMINI_API_KEY_PROD: ${env:GEMINI_API_KEY_PROD, ''}
  apiGateway:
    # Enable API Gateway API keys
    apiKeys:
      - name: ${self:service}-${self:provider.stage}-key
        description: API key for ${self:service} service in ${self:provider.stage} stage
        value: ${env:API_KEY, ''}  # Use value from environment variables
    usagePlan:
      throttle:
        burstLimit: 200
        rateLimit: 100
  iam:
    role:
      statements:
        # Default permissions for all functions
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "arn:aws:logs:*:*:*"

package:
  individually: true
  patterns:
    - '!node_modules/**'
    - '!.venv/**'
    - '!venv/**'
    - '!.gitignore'
    - '!.git/**'
    - '!__pycache__/**'
    - '!**/__pycache__/**'
    - '!tests/**'
    - '!.pytest_cache/**'
    - '!.vscode/**'
    - '!htmlcov/**'
    - '!.github/**'
    - '!.flake8'
    - '!.env'
    - '!.env*'
    - '!.coverage*'
    - '!README.md'
    - '!*.md'
    - '!package.json'
    - '!package-lock.json'
    - '!serverless.yml'
    - '!pyproject.toml'
    - '!requirements*.txt'
    - '!coverage.xml'
    - '!code_quality.sh'
    - '!manage.py'
    - '!.requirements.zip'
    - '!*.pyc'
    - '!**/*.pyc'

functions:
  # Cognito Custom Auth Triggers
  cognitoDefineAuthChallenge:
    handler: src/functions/cognito_triggers/define_auth_challenge.lambda_handler
    description: Cognito trigger to define custom authentication challenge flow
    timeout: 5
    memorySize: 128
    package:
      patterns:
        - src/functions/cognito_triggers/**
        - src/shared/**
    environment:
      FUNCTION_NAME: cognito_define_auth_challenge
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19

  cognitoCreateAuthChallenge:
    handler: src/functions/cognito_triggers/create_auth_challenge.lambda_handler
    description: Cognito trigger to create custom authentication challenge
    timeout: 5
    memorySize: 128
    package:
      patterns:
        - src/functions/cognito_triggers/**
        - src/shared/**
    environment:
      FUNCTION_NAME: cognito_create_auth_challenge
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19

  cognitoVerifyAuthChallengeResponse:
    handler: src/functions/cognito_triggers/verify_auth_challenge_response.lambda_handler
    description: Cognito trigger to verify custom authentication challenge response
    timeout: 10
    memorySize: 256
    package:
      patterns:
        - src/functions/cognito_triggers/**
        - src/shared/**
    environment:
      FUNCTION_NAME: cognito_verify_auth_challenge_response
      AUTH_CODES_TABLE: ${self:provider.stage}-auris-auth-codes
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:Query
          - dynamodb:UpdateItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-auth-codes
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-auth-codes/index/*
      - Effect: Allow
        Action:
          - dynamodb:ListTables
        Resource: "*"
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:cognito_verify_auth_challenge_response:1

  city_collector:
    handler: src/functions/city_collector/handler.city_collector
    description: City Collector Lambda function
    timeout: 29
    events:
      - http:
          path: city_collector
          method: post
          cors: true
          private: true  # Require API key
      - eventBridge:
          pattern:
            source:
              - custom.cityCollector
            detail-type:
              - City Collection Request
    package:
      patterns:
        - src/functions/city_collector/**
        - src/shared/**
    environment:
      # Function specific environment variables
      FUNCTION_NAME: city_collector
      SCRAPER_TASK_QUEUE_URL: !Ref ScraperTaskQueue
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - sqs:SendMessage
        Resource: !GetAtt ScraperTaskQueue.Arn
    layers:
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:city_collector_layer:1
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19

  gmaps_scrapper:
    handler: src/functions/data_scrapper/gmaps_handler.gmaps_scrapper
    description: Data Scrapper Lambda function that processes scraping tasks
    timeout: 300
    memorySize: 512
    events:
      - sqs:
          arn: !GetAtt ScraperTaskQueue.Arn
          batchSize: 1
    package:
      patterns:
        - src/functions/data_scrapper/**
        - src/shared/**
        - src/models/**
    environment:
      FUNCTION_NAME: data_scrapper
      COMPANIES_TABLE: ${self:provider.stage}-auris-core-companies
      PLACES_TABLE: ${self:provider.stage}-auris-core-places
      WEBSITE_SCRAPER_TASK_QUEUE_URL: !Ref WebsiteScraperTaskQueue
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:Scan
          - dynamodb:Query
          - dynamodb:DescribeTable
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-places
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-companies
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-places/index/*
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-companies/index/*
          - "arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/*"
      - Effect: Allow
        Action:
          - sqs:SendMessage
        Resource: !GetAtt WebsiteScraperTaskQueue.Arn
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:gmaps_scrapper:2

  website_scrapper:
    handler: src/functions/data_scrapper/website_handler.website_scrapper
    description: Website Scrapper Lambda function that processes website scraping tasks
    timeout: 300
    memorySize: 512
    events:
      - sqs:
          arn: !GetAtt WebsiteScraperTaskQueue.Arn
          batchSize: 1
    package:
      patterns:
        - '!./**'  # Exclude everything first
        - 'src/functions/data_scrapper/**'  # Then include only what we need
        - 'src/shared/**'
        - 'src/models/**'
        - '!src/**/__pycache__/**'
        - '!**/*.pyc'
    environment:
      FUNCTION_NAME: website_scrapper
      COMPANIES_TABLE: ${self:provider.stage}-auris-core-companies
      COMPANY_FEDERAL_SCRAPER_TASK_QUEUE_URL: !Ref CompanyFederalScraperTaskQueue
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:Query
          - dynamodb:DescribeTable
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-companies
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-companies/index/*
          - "arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/*"
      - Effect: Allow
        Action:
          - sqs:SendMessage
        Resource: !GetAtt CompanyFederalScraperTaskQueue.Arn
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:website_scrapper:3

  company_federal_scrapper:
    handler: src/functions/data_scrapper/company_federal_handler.company_federal_scrapper
    description: Company Federal Scrapper Lambda function that fetches data from OpenCNPJ API
    timeout: 60
    memorySize: 256
    events:
      - sqs:
          arn: !GetAtt CompanyFederalScraperTaskQueue.Arn
          batchSize: 1
    package:
      patterns:
        - src/functions/data_scrapper/**
        - src/shared/**
        - src/models/**
    environment:
      FUNCTION_NAME: company_federal_scrapper
      COMPANIES_TABLE: ${self:provider.stage}-auris-core-companies
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:Query
          - dynamodb:DescribeTable
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-companies
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-companies/index/*
          - "arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/*"
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:company_federal_scrapper:2

  gl_add_new_lead:
    handler: src/functions/gl_add_new_lead/add_new_lead_handler.add_new_lead
    description: HTTP endpoint for creating new leads in the CRM system (Cognito authentication required)
    timeout: 29
    memorySize: 256
    events:
      - http:
          path: leads
          method: options
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
            allowCredentials: false
            maxAge: 86400
      - http:
          path: leads
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
            allowCredentials: false
            maxAge: 86400
          authorizer:
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn.${self:provider.stage}}
    package:
      patterns:
        - src/functions/gl_add_new_lead/**
        - src/shared/**
        - src/models/**
    environment:
      FUNCTION_NAME: gl_add_new_lead
      LEADS_TABLE: ${self:provider.stage}-auris-core-leads
      COMPANIES_TABLE: ${self:provider.stage}-auris-core-companies
      COMMUNICATION_HISTORY_TABLE: ${self:provider.stage}-auris-core-communication-history
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:Query
          - dynamodb:DescribeTable
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-leads
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-leads/index/*
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-companies
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-communication-history
      - Effect: Allow
        Action:
          - dynamodb:ListTables
        Resource: "*"
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:gl_add_new_lead:3

  gl_database_import_generate_url:
    handler: src/functions/gl_database_import/gl_database_import_handler.generate_presigned_upload_url
    description: Generate pre-signed S3 URL for database import file upload (Cognito authentication required)
    timeout: 29
    memorySize: 256
    events:
      - http:
          path: database-import/generate-upload-url
          method: options
          cors:
            origin: '*'
            headers:
              - Content-Type
              - x-api-key
              - X-Amz-Date
              - Authorization
              - X-Api-Key
            allowCredentials: false
            maxAge: 3600
      - http:
          path: database-import/generate-upload-url
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - x-api-key
              - X-Amz-Date
              - Authorization
              - X-Api-Key
            allowCredentials: false
            maxAge: 3600
          authorizer:
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn.${self:provider.stage}}
    package:
      patterns:
        - src/functions/gl_database_import/**
        - src/shared/**
        - src/models/**
    environment:
      FUNCTION_NAME: gl_database_import_generate_url
      IMPORT_STATUS_TABLE: ${self:provider.stage}-auris-core-import-status
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-import-status
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-import-status/index/*
      - Effect: Allow
        Action:
          - dynamodb:ListTables
        Resource: "*"
      - Effect: Allow
        Action:
          - s3:HeadBucket
        Resource:
          - arn:aws:s3:::auris-database-imports
      - Effect: Allow
        Action:
          - s3:PutObject
          - s3:PutObjectAcl
        Resource:
          - arn:aws:s3:::auris-database-imports/*
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:gl_database_import:1

  gl_database_import_orchestrator:
    handler: src/functions/gl_database_import/gl_database_import_handler.database_import_orchestrator
    description: Process uploaded CSV/XLSX files and orchestrate lead import
    timeout: 900  # 15 minutes
    memorySize: 1024
    events:
      - s3:
          bucket: auris-database-imports
          event: s3:ObjectCreated:*
          rules:
            - prefix: uploads/
            - suffix: .csv
          existing: true
      - s3:
          bucket: auris-database-imports
          event: s3:ObjectCreated:*
          rules:
            - prefix: uploads/
            - suffix: .xlsx
          existing: true
    package:
      patterns:
        - src/functions/gl_database_import/**
        - src/functions/gl_add_new_lead/**
        - src/shared/**
        - src/models/**
    environment:
      FUNCTION_NAME: gl_database_import_orchestrator
      LEADS_TABLE: ${self:provider.stage}-auris-core-leads
      IMPORT_STATUS_TABLE: ${self:provider.stage}-auris-core-import-status
      AWS_REGION_NAME: ${self:provider.region}
      OPERATIONS_QUEUE_URL:
        Ref: OperationsQueue
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-leads
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-leads/index/*
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-import-status
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-import-status/index/*
      - Effect: Allow
        Action:
          - dynamodb:ListTables
        Resource: "*"
      - Effect: Allow
        Action:
          - s3:GetObject
          - s3:PutObject
          - s3:DeleteObject
          - s3:CopyObject
          - s3:HeadObject
        Resource:
          - arn:aws:s3:::auris-database-imports/*
      - Effect: Allow
        Action:
          - s3:ListBucket
        Resource:
          - arn:aws:s3:::auris-database-imports
      - Effect: Allow
        Action:
          - sqs:SendMessage
          - sqs:SendMessageBatch
        Resource:
          - !GetAtt OperationsQueue.Arn
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:gl_database_import:1

  gl_database_import_status:
    handler: src/functions/gl_database_import/gl_database_import_handler.get_import_status
    description: Get database import status with timeout detection (Cognito authentication required)
    timeout: 10
    memorySize: 256
    events:
      - http:
          path: database-import/status
          method: options
          cors:
            origin: '*'
            headers:
              - Content-Type
              - x-api-key
              - X-Amz-Date
              - Authorization
              - X-Api-Key
            allowCredentials: false
            maxAge: 3600
      - http:
          path: database-import/status
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - x-api-key
              - X-Amz-Date
              - Authorization
              - X-Api-Key
            allowCredentials: false
            maxAge: 3600
          authorizer:
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn.${self:provider.stage}}
    package:
      patterns:
        - src/functions/gl_database_import/**
        - src/shared/**
        - src/models/**
    environment:
      FUNCTION_NAME: gl_database_import_status
      IMPORT_STATUS_TABLE: ${self:provider.stage}-auris-core-import-status
      LEADS_TABLE: ${self:provider.stage}-auris-core-leads
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-import-status
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-leads
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-leads/index/*
      - Effect: Allow
        Action:
          - dynamodb:ListTables
        Resource: "*"
      - Effect: Allow
        Action:
          - s3:GetObject
        Resource:
          - arn:aws:s3:::auris-database-imports/*
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:gl_database_import:1

  gl_add_new_company:
    handler: src/functions/gl_add_new_company/add_new_company_handler.add_new_company
    description: HTTP endpoint for creating new companies in the CRM system
    timeout: 29
    memorySize: 256
    events:
      - http:
          path: companies
          method: post
          cors: true
          private: true  # Require API key
    package:
      patterns:
        - src/functions/gl_add_new_company/**
        - src/shared/**
    environment:
      FUNCTION_NAME: gl_add_new_company
      COMPANIES_TABLE: ${self:provider.stage}-auris-core-companies
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:Scan
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-companies
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19

  gl_login:
    handler: src/functions/gl_login/login_handler.login
    description: HTTP endpoint for user authentication via email lookup
    timeout: 29
    memorySize: 256
    events:
      - http:
          path: login
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - x-api-key
              - X-Amz-Date
              - Authorization
              - X-Amz-Date
              - X-Api-Key
            allowCredentials: false
      - http:
          path: login
          method: options
          cors:
            origin: '*'
            headers:
              - Content-Type
              - x-api-key
              - X-Amz-Date
              - Authorization
              - X-Amz-Date
              - X-Api-Key
            allowCredentials: false
    package:
      patterns:
        - src/functions/gl_login/**
        - src/shared/**
    environment:
      FUNCTION_NAME: gl_login
      COMPANIES_TABLE: ${self:provider.stage}-auris-core-companies
      USERS_TABLE: ${self:provider.stage}-auris-core-companies-users
      AUTH_CODES_TABLE: ${self:provider.stage}-auris-auth-codes
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-companies
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:Query
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-companies-users
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-companies-users/index/userEmailIndex
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-auth-codes
      - Effect: Allow
        Action:
          - dynamodb:ListTables
        Resource: "*"
      - Effect: Allow
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: "*"
      - Effect: Allow
        Action:
          - ses:GetAccount
          - ses:GetSendQuota
          - ses:GetSendStatistics
        Resource: "*"
      - Effect: Allow
        Action:
          - cognito-idp:AdminCreateUser
          - cognito-idp:AdminEnableUser
          - cognito-idp:AdminConfirmSignUp
          - cognito-idp:AdminUpdateUserAttributes
          - cognito-idp:ListUsers
          - cognito-idp:InitiateAuth
          - cognito-idp:RespondToAuthChallenge
        Resource: "*"
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:gl_login:2

  gl_fetch_leads:
    handler: src/functions/gl_fetch_leads/fetch_leads_handler.fetch_leads_reminders
    description: HTTP endpoint for fetching lead based on reminders date and company ID (Cognito authentication required)
    timeout: 29
    memorySize: 256
    events:
      - http:
          path: leads/fetch_reminders
          method: options
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
            allowCredentials: false
            maxAge: 86400
      - http:
          path: leads/fetch_reminders
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
            allowCredentials: false
            maxAge: 86400
          authorizer:
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn.${self:provider.stage}}
    package:
      patterns:
        - src/functions/gl_fetch_leads/**
        - src/shared/**
    environment:
      FUNCTION_NAME: gl_fetch_leads
      LEADS_TABLE: ${self:provider.stage}-auris-core-leads
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:Scan
          - dynamodb:Query
          - dynamodb:DescribeTable
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-leads
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-leads/index/*
      - Effect: Allow
        Action:
          - dynamodb:ListTables
        Resource: "*"
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:gl_fetch_leads:1

  gl_fetch_lead_history:
    handler: src/functions/gl_fetch_lead_history/fetch_lead_history_handler.fetch_lead_history
    description: HTTP endpoint for fetching organized communication history by communicationIDs and company ID (Cognito authentication required)
    timeout: 29
    memorySize: 256
    events:
      - http:
          path: leads/fetch_history
          method: options
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
            allowCredentials: false
            maxAge: 86400
      - http:
          path: leads/fetch_history
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
            allowCredentials: false
            maxAge: 86400
          authorizer:
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn.${self:provider.stage}}
    package:
      patterns:
        - src/functions/gl_fetch_lead_history/**
        - src/shared/**
    environment:
      FUNCTION_NAME: gl_fetch_lead_history
      LEADS_TABLE: ${self:provider.stage}-auris-core-leads
      COMMUNICATION_HISTORY_TABLE: ${self:provider.stage}-auris-core-communication-history
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:BatchGetItem
          - dynamodb:DescribeTable
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-communication-history
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-leads
      - Effect: Allow
        Action:
          - dynamodb:ListTables
        Resource: "*"
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:gl_fetch_lead_history:1

  gl_queue_manager:
    handler: src/functions/gl_queue_manager/gl_queue_manager_handler.gl_queue_manager
    description: Hub lambda function that routes operations by invoking target Lambda functions synchronously
    timeout: 29
    memorySize: 128
    events:
      - sqs:
          arn: !GetAtt OperationsQueue.Arn
          batchSize: 1
    package:
      patterns:
        - src/functions/gl_queue_manager/**
        - src/shared/**
    environment:
      FUNCTION_NAME: gl_queue_manager
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - lambda:InvokeFunction
        Resource:
          - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:function:gl-add-new-lead
          - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:function:${self:service}-${self:provider.stage}-*
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:gl_queue_manager:1

  gl_communication_registration:
    handler: src/functions/gl_communication_registration/gl_communication_registration_handler.communication_registration
    description: Register communications and update lead records with validation (Cognito authentication required for HTTP endpoint, or invoked by gl_queue_manager)
    timeout: 29
    memorySize: 256
    events:
      - http:
          path: leads/communication_register
          method: options
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
            allowCredentials: false
            maxAge: 86400
      - http:
          path: leads/communication_register
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization
              - X-Amz-Date
              - X-Api-Key
            allowCredentials: false
            maxAge: 86400
          authorizer:
            type: COGNITO_USER_POOLS
            arn: ${self:custom.cognitoUserPoolArn.${self:provider.stage}}
    package:
      patterns:
        - src/functions/gl_communication_registration/**
        - src/shared/**
        - src/shared/schema/gl_new_lead_schema.json
        - src/shared/schema/communication_history_schema.json
    environment:
      FUNCTION_NAME: gl_communication_registration
      LEADS_TABLE: ${self:provider.stage}-auris-core-leads
      COMMUNICATION_HISTORY_TABLE: ${self:provider.stage}-auris-core-communication-history
      AWS_REGION_NAME: ${self:provider.region}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-leads
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
        Resource:
          - arn:aws:dynamodb:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:table/${self:provider.stage}-auris-core-communication-history
      - Effect: Allow
        Action:
          - dynamodb:ListTables
        Resource: "*"
    layers:
      - arn:aws:lambda:${self:provider.region}:017000801446:layer:AWSLambdaPowertoolsPythonV3-python310-x86_64:19
      - arn:aws:lambda:${self:provider.region}:${env:AWS_ACCOUNT_ID, '819774487459'}:layer:gl_communication_registration:1

plugins:
  - serverless-dotenv-plugin
  - serverless-offline
  - serverless-add-api-key

custom:
  # Cognito User Pool ARN for the current stage
  cognitoUserPoolArn:
    dev: arn:aws:cognito-idp:${self:provider.region}:${self:provider.environment.ACCOUNT_ID}:userpool/${env:COGNITO_USER_POOL_ID_DEV}
    prod: arn:aws:cognito-idp:${self:provider.region}:${self:provider.environment.ACCOUNT_ID}:userpool/${env:COGNITO_USER_POOL_ID_PROD}
  apiKey:
    name: ${self:service}-${self:provider.stage}-api-key
    description: API key for ${self:service} service in ${self:provider.stage} stage

resources:
  Resources:
    # SQS Queues
    ScraperTaskQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-scraper-tasks
        VisibilityTimeout: 300
        MessageRetentionPeriod: 86400  # 1 day
        ReceiveMessageWaitTimeSeconds: 0
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt ScraperTaskDLQ.Arn
          maxReceiveCount: 3  # After 3 failed attempts, move to DLQ
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}

    ScraperTaskDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-scraper-tasks-dlq
        MessageRetentionPeriod: 1209600  # 14 days
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}

    ScraperAlarmTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:service}-${self:provider.stage}-scraper-alerts
        DisplayName: Scraper Task Failure Alerts
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}

    ScraperAlarmTopicSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: email
        TopicArn: !Ref ScraperAlarmTopic
        Endpoint: ${env:ALARM_EMAIL, 'your-email@example.com'}

    ScraperTaskDLQAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-scraper-dlq-alarm
        AlarmDescription: Alert when messages are sent to the DLQ (scraping failures)
        MetricName: ApproximateNumberOfMessagesVisible
        Namespace: AWS/SQS
        Statistic: Sum
        Period: 60
        EvaluationPeriods: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Dimensions:
          - Name: QueueName
            Value: !GetAtt ScraperTaskDLQ.QueueName
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref ScraperAlarmTopic

    # Website Scraper SQS Queues
    WebsiteScraperTaskQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-website-scraper-tasks
        VisibilityTimeout: 360  # 6 minutes (higher than Lambda timeout)
        MessageRetentionPeriod: 86400  # 1 day
        ReceiveMessageWaitTimeSeconds: 0
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt WebsiteScraperTaskDLQ.Arn
          maxReceiveCount: 2  # After 2 failed attempts, move to DLQ
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}

    WebsiteScraperTaskDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-website-scraper-tasks-dlq
        MessageRetentionPeriod: 1209600  # 14 days
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}

    WebsiteScraperTaskDLQAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-website-scraper-dlq-alarm
        AlarmDescription: Alert when messages are sent to the website scraper DLQ (scraping failures)
        MetricName: ApproximateNumberOfMessagesVisible
        Namespace: AWS/SQS
        Statistic: Sum
        Period: 60
        EvaluationPeriods: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Dimensions:
          - Name: QueueName
            Value: !GetAtt WebsiteScraperTaskDLQ.QueueName
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref ScraperAlarmTopic

    # Company Federal Scraper SQS Queues
    CompanyFederalScraperTaskQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-company-federal-scraper-tasks
        VisibilityTimeout: 90  # 1.5 minutes (higher than Lambda timeout)
        MessageRetentionPeriod: 86400  # 1 day
        ReceiveMessageWaitTimeSeconds: 0
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt CompanyFederalScraperTaskDLQ.Arn
          maxReceiveCount: 2  # After 2 failed attempts, move to DLQ
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}

    CompanyFederalScraperTaskDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-company-federal-scraper-tasks-dlq
        MessageRetentionPeriod: 1209600  # 14 days
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}

    CompanyFederalScraperTaskDLQAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-company-federal-scraper-dlq-alarm
        AlarmDescription: Alert when messages are sent to the company federal scraper DLQ (scraping failures)
        MetricName: ApproximateNumberOfMessagesVisible
        Namespace: AWS/SQS
        Statistic: Sum
        Period: 60
        EvaluationPeriods: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Dimensions:
          - Name: QueueName
            Value: !GetAtt CompanyFederalScraperTaskDLQ.QueueName
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref ScraperAlarmTopic

    # Operations Queue for Hub Lambda (gl_queue_manager)
    OperationsQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-gl-operations-queue
        VisibilityTimeout: 60
        MessageRetentionPeriod: 86400  # 1 day
        ReceiveMessageWaitTimeSeconds: 0
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt OperationsQueueDLQ.Arn
          maxReceiveCount: 1  # After 1 failed attempt, move to DLQ
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}

    OperationsQueueDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-gl-operations-queue-dlq
        MessageRetentionPeriod: 1209600  # 14 days
        Tags:
          - Key: Service
            Value: ${self:service}
          - Key: Stage
            Value: ${self:provider.stage}

    OperationsQueueDLQAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-operations-dlq-alarm
        AlarmDescription: Alert when messages are sent to the operations queue DLQ
        MetricName: ApproximateNumberOfMessagesVisible
        Namespace: AWS/SQS
        Statistic: Sum
        Period: 60
        EvaluationPeriods: 1
        Threshold: 5
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Dimensions:
          - Name: QueueName
            Value: !GetAtt OperationsQueueDLQ.QueueName
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref ScraperAlarmTopic
